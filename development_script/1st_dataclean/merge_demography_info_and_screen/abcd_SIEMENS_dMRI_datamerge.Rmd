---
title: "abcd_SIEMENS_dMRI_datamerge"
author: "Xiaoyu xu"
date: "3/6/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
rm(list=ls())
library(tidyverse)
library(psych)
library(openxlsx)

info_path <- "/Users/xuxiaoyu_work/Cuilab/open_dataset_information/ABCD/info"
datapath <- "/Volumes/exchange/abcd-data-release-5.0/abcd-data-release-5.1/core"
datapath4 <- "/Users/xuxiaoyu_work/Cuilab/DMRI_network_development/ABCD_download_organise/behavior"
```

## Screen data

This script is to screen the data from data-screening  based on demographic and diagnosis.

## 1. screen data by MRI information
Because all the MRI data were downloaded and organised according to files from release 4.0, the imaging data will be screened according to files from release 4.0.
```{r MRI_screen}
abcd_mri01 <- read.xlsx(paste0(datapath4, '/abcd_mri01.xlsx'))
abcd_mri01 <- abcd_mri01[-1,]
abcd_mri01 <- abcd_mri01[,c(5,7,9,12, 14)]
abcd_imgincl01 <- read.xlsx(paste0(datapath4, '/abcd_imgincl01.xlsx'))
abcd_imgincl01 <- abcd_imgincl01[-1,-c(1:4, 6, 10,18)]
data_raw <- read.csv(paste0(info_path, '/data_raw.csv'))
data_nifti <- read.csv(paste0(info_path, '/SIEMENS_niftilist.csv'))
failBIDScheck <- read.table(paste0(info_path, '/dmrismridcmnum.txt'), header = T)
names(failBIDScheck)[4:5] <- c("dmridcmnum", "smridcmnum")
failBIDScheck <- failBIDScheck %>% filter(dmridcmnum!=103 | smridcmnum!=176)
failBIDScheck$scanID <- paste0(failBIDScheck$subID, "_ses-", failBIDScheck$eventname)
failBIDScheck <- failBIDScheck %>% distinct(scanID, .keep_all = T)
process_df <- read.csv(paste0(info_path, '/qsi_S_addinfo.csv'))
process_df <- process_df[,c("scanID", "subID", "qsiprepfinished", "failT1Parcellation")]

demodf_s1 <- abcd_mri01
demodf_s1 <- merge(demodf_s1, abcd_imgincl01, by=c("src_subject_id", "eventname"))
#1 only SIEMENS
demodf_s1 <- demodf_s1 %>% filter(mri_info_manufacturer=="SIEMENS")
num_SIEMENS <- nrow(demodf_s1)
print(paste0("1st, we only include scans from SIEMENS scanner, ", nrow(demodf_s1), " were included, ", table(demodf_s1$eventname)[2], " from baseline; ", table(demodf_s1$eventname)[1], " from 2year-FU; ", length(unique(demodf_s1$src_subject_id)), " unique participants."))
#2 data downloaded
data_raw$eventname <- gsub("b", "baseline_year_1_arm_1", data_raw$eventname)
data_raw$eventname <- gsub("2", "2_year_follow_up_y_arm_1", data_raw$eventname)
data_raw$subID <- paste0("sub-NDAR", data_raw$subID)
demodf_s1$subID <- paste0("sub-", gsub("_", "", demodf_s1$src_subject_id))
demodf_s1 <- merge(demodf_s1, data_raw, by=c("subID", "eventname"), all.x = T)
demodf_s1 <- demodf_s1 %>% filter(num_dMRI_raw>0 & num_sMRI_raw>0 & num_fmap_AP_raw>0)
num_download <- nrow(demodf_s1)
print(paste0("2nd, we successfully downloaded ", num_download, " scans with dMRI, sMRI and fMRI."))
print(paste0(table(demodf_s1$eventname)[2], " participants from baseline, ", table(demodf_s1$eventname)[1], " participants from 2-year FU"))
#3 failed qc
demodf_s1 <- demodf_s1 %>% filter(imgincl_t1w_include==1 & imgincl_dmri_include==1)
num_exclu4qc <- num_download-nrow(demodf_s1)
print(paste0("3rd, we exclude ", num_exclu4qc, " scans for no recommendation from official QC."))
#4 successful BIDS
data_nifti$scanID <- paste0(data_nifti$subID, '_', data_nifti$eventname)
SIEMENS_nifti_complete <- data.frame(scanID=unique(data_nifti$scanID), dMRI=rep(NA, times=length(unique(data_nifti$scanID))),
                                     sMRI=rep(NA, times=length(unique(data_nifti$scanID))), fmap_AP=rep(NA, times=length(unique(data_nifti$scanID))),
                                     fmap_PA=rep(NA, times=length(unique(data_nifti$scanID))))
for (i in 1:nrow(SIEMENS_nifti_complete)){
  scanID <- SIEMENS_nifti_complete$scanID[i]
  indexID <- which(data_nifti$scanID==scanID)
  data.tmp <- data_nifti$filename[indexID]
  dwinum <- length(which(str_detect(data.tmp, "_dwi")))
  sMRInum <- length(which(str_detect(data.tmp, "_T1w")))
  fmap_APnum <- length(which(str_detect(data.tmp, "_dir-AP") | str_detect(data.tmp, "FM-AP")))
  fmap_PAnum <- length(which(str_detect(data.tmp, "_dir-PA") | str_detect(data.tmp, "FM-PA")))
  SIEMENS_nifti_complete[i, 2:5] <- c(dwinum, sMRInum, fmap_APnum, fmap_PAnum)
  SIEMENS_nifti_complete$eventnames[i] <- data_nifti$eventname[indexID[1]]
}
SIEMENS_nifti_complete$completeness <- (SIEMENS_nifti_complete$dMRI>0 & SIEMENS_nifti_complete$sMRI>0 & SIEMENS_nifti_complete$fmap_AP>0)
demodf_s1$eventname2 <- str_replace_all(demodf_s1$eventname, "_(\\w)", function(x) toupper(x))
demodf_s1$scanID <- paste0(demodf_s1$subID, "_ses-", gsub("_", "", demodf_s1$eventname2))
demodf_s1 <- merge(demodf_s1, SIEMENS_nifti_complete, by="scanID", all.x=T)
demodf_s1$completeness[which(is.na(demodf_s1$completeness))] <-0

scanlist_noBIDS <- demodf_s1$scanID[which(demodf_s1$completeness!=1)]
failBIDScheck1 <- failBIDScheck[failBIDScheck$scanID %in% scanlist_noBIDS,]
scanlist_noBIDS[!scanlist_noBIDS %in% failBIDScheck$scanID]

num_incompletedata <- length(which((failBIDScheck1$dmridcmnum>0 & failBIDScheck1$dmridcmnum<103) | (failBIDScheck1$smridcmnum>0 & failBIDScheck1$smridcmnum<176)))
num_failzip <- length(scanlist_noBIDS) - num_incompletedata

demodf_s1 <- demodf_s1 %>% filter(completeness==1)

demodf_s1 <- merge(demodf_s1, process_df, by="scanID", all.x = T)
scanlist_noBIDS2 <- demodf_s1$scanID[is.na(demodf_s1$qsiprepfinished)]
failBIDScheck2 <- failBIDScheck[failBIDScheck$scanID %in% scanlist_noBIDS2,]
scanlist_noBIDS2[!scanlist_noBIDS2 %in% failBIDScheck2$scanID]
num_incompletedata <- num_incompletedata+length(which((failBIDScheck2$dmridcmnum>0 & failBIDScheck2$dmridcmnum<103) | (failBIDScheck2$smridcmnum>0 & failBIDScheck2$smridcmnum<176)))
num_failzip <- num_failzip+nrow(failBIDScheck2) - length(which((failBIDScheck2$dmridcmnum>0 & failBIDScheck2$dmridcmnum<103) | (failBIDScheck2$smridcmnum>0 & failBIDScheck2$smridcmnum<176)))
num_faildcm2nii <- length(scanlist_noBIDS2) - nrow(failBIDScheck2)
demodf_s1 <- demodf_s1[!is.na(demodf_s1$qsiprepfinished),]
for (i in 1){
  print(paste0("4th, ", nrow(demodf_s1), "scans were successfully organised to BIDS, ", table(demodf_s1$eventname)[2], " from baseline, ",  table(demodf_s1$eventname)[1], " from 2year-Fu, ", length(unique(demodf_s1$src_subject_id)), " unique participants."))
print(paste0("Appendex to 4th: ", num_incompletedata, " scans failed for incomplete data; ", num_failzip, " scans failed unzip; ", num_faildcm2nii, " scans failed dcm2niix."))
}

```

## 2. screen data by demographic information
```{r}
demodf <- read.csv(paste0(info_path, '/demo_sublist_criteria.csv'))
abcd_y_lt <- read.csv(paste0(datapath, '/abcd-general/abcd_y_lt.csv'))
abcd_y_lt <- abcd_y_lt[which(abcd_y_lt$eventname=='baseline_year_1_arm_1' | abcd_y_lt$eventname=='2_year_follow_up_y_arm_1'),]
abcd_y_lt <- abcd_y_lt[,c(1:3,9)]
nc_y_ehis <- read.csv(paste0(datapath, '/neurocognition/nc_y_ehis.csv'))
nc_y_ehis <- nc_y_ehis[nc_y_ehis$eventname=='baseline_year_1_arm_1',]
nc_y_ehis <- nc_y_ehis[,c(1,8)]

demodf <- merge(demodf, abcd_y_lt, by=c("src_subject_id", "eventname"))
demodf <- merge(demodf, nc_y_ehis, by=c("src_subject_id"), all.x = T)
demodf_s2 <- merge(demodf_s1, demodf, by=c("src_subject_id", "eventname"), all.x = T)
#1
demodf_s2 <- demodf_s2 %>% filter(if_language_y==FALSE & if_language_p==FALSE)
num_exclu4language = nrow(demodf)-nrow(demodf_s2)
#2
demodf_s2 <- demodf_s2 %>% filter(if_TBI==FALSE)
num_exclu4TBI = nrow(demodf)-nrow(demodf_s2)-num_exclu4language
#3
demodf_s2 <- demodf_s2 %>% filter(if_sensory==FALSE)
num_exclu4sensory = nrow(demodf)-nrow(demodf_s2)-num_exclu4language-num_exclu4TBI
#4
demodf_s2 <- demodf_s2 %>% filter(if_intel==FALSE)
num_exclu4inel = nrow(demodf)-nrow(demodf_s2)-num_exclu4language-num_exclu4TBI-num_exclu4sensory
#5
demodf_s2 <- demodf_s2 %>% filter(if_medical==FALSE)
num_exclu4medical = nrow(demodf)-nrow(demodf_s2)-num_exclu4language-num_exclu4TBI-num_exclu4sensory-num_exclu4inel
#6
demodf_s2 <- demodf_s2 %>% filter(if_contra==FALSE)
num_exclu4contra = nrow(demodf)-nrow(demodf_s2)-num_exclu4language-num_exclu4TBI-num_exclu4sensory-num_exclu4inel-num_exclu4medical
#7
demodf_s2 <- demodf_s2 %>% filter(if_premature==FALSE)
num_exclu4premature = nrow(demodf)-nrow(demodf_s2)-num_exclu4language-num_exclu4TBI-num_exclu4sensory-num_exclu4inel-num_exclu4medical-num_exclu4contra
#8
demodf_s2 <- demodf_s2 %>% filter(if_age==F & if_gender==F)
num_exclu4agegender = nrow(demodf)-nrow(demodf_s2)-num_exclu4language-num_exclu4TBI-num_exclu4sensory-num_exclu4inel-num_exclu4medical-num_exclu4contra-num_exclu4premature
#9
demodf_s2 <- demodf_s2 %>% drop_na(c("race", "ehi_y_ss_scoreb"))
num_exclu4racehand = nrow(demodf)-nrow(demodf_s2)-num_exclu4language-num_exclu4TBI-num_exclu4sensory-num_exclu4inel-num_exclu4medical-num_exclu4contra-num_exclu4premature-num_exclu4agegender

demodf_s2[,6:15] <- NULL
write.csv(demodf_s2, paste0(info_path, '/DemodfScreenByDemoinfo.csv'), row.names = F)
for (i in 1){
  print(paste0("1st, we exclude ", num_exclu4language, " scans for English proficiency in children or English/Spanish proficiency in their parents."))
  print(paste0("2nd, we exclude ", num_exclu4TBI, " scans for mild and above TBI."))
  print(paste0("3rd, we exclude ", num_exclu4sensory, " scans for sensory issues."))
  print(paste0("4th, we exclude ", num_exclu4inel, " scans for intellectual disability."))
  print(paste0("5th, we exclude ", num_exclu4medical, " scans for major medical or neurological conditions."))
  print(paste0("6th, we exclude ", num_exclu4contra, " scans for contraindications to MRI scanning."))
  print(paste0("7th, we exclude ", num_exclu4premature, " scans for premature or low birth weight."))
  print(paste0("8th, we exclude ", num_exclu4agegender, " scans for invalid age & sex."))
  print(paste0("9th, we exclude ", num_exclu4racehand, " scans for invalid race & handedness."))
  print(paste0("Finally, ", nrow(demodf_s2), " scans left after this step, ", table(demodf_s2$eventname)[2], " from baseline, ",  table(demodf_s2$eventname)[1], " from 2year-Fu, ", length(unique(demodf_s2$src_subject_id)), " unique participants."))
}

```

## 3. data successfully passed qsiprep & head motion criteria

```{r}
demodf_orig <- read.csv(paste0(info_path, '/qsi_S_addinfo.csv'))

# 1 qsiprep finished
demodf_s3 <- demodf_s2[which(demodf_s2$qsiprepfinished==TRUE & demodf_s2$failT1Parcellation==FALSE), ]
num_failqsiprep <- nrow(demodf_s2) - nrow(demodf_s3)
# 2 high head motion
demodf_s3$scanID.x <- demodf_s3$subID.x <- demodf_s3$subID.y <- NULL
demodf_s3 <- dplyr::rename(demodf_s3, scanID="scanID.y")
demodf_s3 <- demodf_s3 %>% left_join(select(demodf_orig, scanID, mean_fd), by="scanID")
highmotion_thr <- mean(demodf_s3$mean_fd)+3*sd(demodf_s3$mean_fd)
demodf_s3 <- demodf_s3 %>% filter(mean_fd < highmotion_thr)
num_exclu4highmotion <- nrow(demodf_s2) - num_failqsiprep - nrow(demodf_s3)
# 3. sites with fewer scans
tab <- table(demodf_s3$site_id_l)
siteexclude <- names(tab)[which(tab < 100)]
# clean
demodf_s3$subID.y <- NULL
demodf_s3$interview_age.x<- demodf_s3$interview_age.y <- NULL
demodf_s3[,which(str_detect(names(demodf_s3),"_ft") | str_detect(names(demodf_s3), "_raw") | str_detect(names(demodf_s3), "if_"))] <- NULL
#names(demodf_s3)
demodf_s3$eventname2 <- demodf_s3$eventnames <- NULL
abcd_p_demo <- read.csv(paste0(datapath,'/abcd-general/abcd_p_demo.csv'))
abcd_p_demo <- abcd_p_demo %>% group_by(src_subject_id) %>% 
  mutate(demo_sex_v2 = zoo::na.locf(demo_sex_v2)) %>%
  mutate(demo_sex_v2 = zoo::na.locf(demo_sex_v2, fromLast = TRUE, na.rm = FALSE)) 
demodf_s3 <- demodf_s3 %>% left_join(select(abcd_p_demo, c("src_subject_id", "eventname", "demo_sex_v2")), join_by("src_subject_id", "eventname"))

demodf_s3 <- demodf_s3 %>% dplyr::rename(c(siteID="site_id_l",age="interview_age",gender="demo_sex_v2", handness="ehi_y_ss_scoreb"))
write.csv(demodf_s3, paste0(info_path, '/DemodfScreenFinal.csv'), row.names = F)
for (i in 1){
  print(paste0("1st, ", num_failqsiprep, " failed processing. Structural connectomes were successfully constructed for ", (nrow(demodf_s2)-num_failqsiprep), " scans."))
  print(paste0("2nd, we exclude ", num_exclu4highmotion, " scans for high head motion."))
  print(paste0("3rd, scans from ", length(siteexclude), " site were fewer than 100."))
  print(paste0("Finally, we included ", nrow(demodf_s3), " scans, ", table(demodf_s3$eventname)[2], " from baseline, ", table(demodf_s3$eventname)[1], " from 2year-FU, ", length(unique(demodf_s3$src_subject_id)), " unique participants."))
}

```

## 4. merge cognition & diagnosis & siteID from release4
```{r}
# diagnosis
diagnosis_subinfo <- read.csv(paste0(info_path, '/diagnosis_subinfo_l.csv'))
diagnosis_subinfo_consist <- read.csv(paste0(info_path, '/diagnosis_subinfo_consist_l.csv'))
demodf_s3 <- demodf_s3 %>% left_join(select(diagnosis_subinfo,scanID, adhd, anx, odd, conduct, dep, td), by="scanID")
demodf_s3 <- demodf_s3 %>% left_join(diagnosis_subinfo_consist, by="subID")
disorder_type <- c("adhd", "anx", "odd", "dep", "td")
write.csv(demodf_s3, paste0(info_path, '/DemodfScreenFinal.csv'), row.names = F)
for (disorder_now in disorder_type){
  num_scans <- table(demodf_s3[,disorder_now])[2]
  num_consist <- table(demodf_s3[,disorder_now],demodf_s3[,paste0(disorder_now, "_consistent")])[2,2]
  print(paste0("In the final sample, ",num_scans, " scans are diagnosed as ", disorder_now, ", ", num_consist, " scans are consistent at two visits."))
}

# cognition
nc_y_nihtb <- read.csv(paste0(datapath, '/neurocognition/nc_y_nihtb.csv'))
interest_cogvar <- c("src_subject_id", "eventname","nihtbx_flanker_uncorrected", "nihtbx_list_uncorrected", "nihtbx_cardsort_uncorrected", "nihtbx_pattern_uncorrected", "nihtbx_fluidcomp_uncorrected", "nihtbx_cryst_uncorrected", "nihtbx_totalcomp_uncorrected")
demodf_s3 <- demodf_s3 %>% left_join(select(nc_y_nihtb, all_of(interest_cogvar)), by=join_by(src_subject_id, eventname))

# adhd & odd
data_comorbidity <- demodf_s3[,disorder_type[c(1,3)]]
idx_comorbidity <- which(rowSums(data_comorbidity) > 1)
demodf_s3$comorbidity_adhd_odd <- (rowSums(data_comorbidity) > 1)
demodf_s3_cog <- demodf_s3 %>% drop_na(nihtbx_fluidcomp_uncorrected)
demodf_s3_cog <- demodf_s3_cog[str_detect(demodf_s3_cog$eventname, "base"),]
for (disorder_now in disorder_type[c(1,3)]) 
{
  idx_disorder <- which(demodf_s3[,disorder_now]==1 & demodf_s3$comorbidity_adhd_odd==FALSE)
  #print(paste0(disorder_now,' (exclude comorbidity): ', as.character(length(idx_disorder)), ' scans' ))
  comorbidity_dis <- demodf_s3[,disorder_now] * !demodf_s3$comorbidity_adhd_odd
  num_consist <- table(comorbidity_dis,demodf_s3[,paste0(disorder_now, "_consistent")])[2,2]
  print(paste0("In the final sample, ",length(idx_disorder), " scans are diagnosed as ", disorder_now, " (exclude comorbidity odd & adhd), ", num_consist, " scans are consistent at two visits."))
  
  idx_disorder <- which(demodf_s3_cog[,disorder_now]==1 & demodf_s3_cog$comorbidity_adhd_odd==FALSE)
  #print(paste0(disorder_now,' (exclude comorbidity): ', as.character(length(idx_disorder)), ' scans' ))
  comorbidity_dis <- demodf_s3_cog[,disorder_now] * !demodf_s3_cog$comorbidity_adhd_odd
  num_consist <- table(comorbidity_dis,demodf_s3_cog[,paste0(disorder_now, "_consistent")])[2,2]
  print(paste0("In the cognition sample, ",length(idx_disorder), " scans are diagnosed as ", disorder_now, " (exclude comorbidity  odd & adhd), ", num_consist, " scans are consistent at two visits."))
}

# adhd & anx & odd
data_comorbidity <- demodf_s3[,disorder_type[c(1,2,3)]]
demodf_s3$comorbidity_adhd_odd_anx <- (rowSums(data_comorbidity) > 1)
demodf_s3_cog <- demodf_s3 %>% drop_na(nihtbx_fluidcomp_uncorrected)
demodf_s3_cog <- demodf_s3_cog[str_detect(demodf_s3_cog$eventname, "base"),]
for (disorder_now in disorder_type[c(1,2,3)]) 
{
  idx_disorder <- which(demodf_s3[,disorder_now]==1 & demodf_s3$comorbidity_adhd_odd_anx==FALSE)
  #print(paste0(disorder_now,' (exclude comorbidity): ', as.character(length(idx_disorder)), ' scans' ))
  comorbidity_dis <- demodf_s3[,disorder_now] * !demodf_s3$comorbidity_adhd_odd_anx
  num_consist <- table(comorbidity_dis,demodf_s3[,paste0(disorder_now, "_consistent")])[2,2]
  print(paste0("In the final sample, ",length(idx_disorder), " scans are diagnosed as ", disorder_now, " (exclude comorbidity odd & adhd), ", num_consist, " scans are consistent at two visits."))
  
  idx_disorder <- which(demodf_s3_cog[,disorder_now]==1 & demodf_s3_cog$comorbidity_adhd_odd_anx==FALSE)
  #print(paste0(disorder_now,' (exclude comorbidity): ', as.character(length(idx_disorder)), ' scans' ))
  comorbidity_dis <- demodf_s3_cog[,disorder_now] * !demodf_s3_cog$comorbidity_adhd_odd_anx
  num_consist <- table(comorbidity_dis,demodf_s3_cog[,paste0(disorder_now, "_consistent")])[2,2]
  print(paste0("In the cognition sample, ",length(idx_disorder), " scans are diagnosed as ", disorder_now, " (exclude comorbidity  odd & adhd), ", num_consist, " scans are consistent at two visits."))
}

# siteID from release 4
abcd_lt01 <- read.xlsx(paste0(datapath4, '/abcd_lt01.xlsx'))
demodf_s3 <- demodf_s3 %>% left_join(select(abcd_lt01, src_subject_id, eventname, site_id_l), join_by(src_subject_id, eventname))
demodf_s3 <- demodf_s3 %>% dplyr::rename(siteID4="site_id_l")
demodf_s3$siteID4 <- gsub("site0", "site", demodf_s3$siteID4)

write.csv(demodf_s3, paste0(info_path, '/DemodfScreenFinal.csv'), row.names = F)

```

```{r, include=FALSE}
# merge pfactor
pFactor.df <- read.csv("/Users/xuxiaoyu_work/Cuilab/open_dataset_information/ABCD/info/p.factor/BifactorP_baseTo3Year.csv")
pFactor.df$eventname <- tolower(pFactor.df$eventname)
pFactor.df <- dplyr::rename(pFactor.df, src_subject_id="srcsubjectid")
demodf_s4 <- base::merge(demodf_s3, pFactor.df, by=c("src_subject_id", "eventname"), all.x = T)

pFactor.WX0 <- read.csv("/Users/xuxiaoyu_work/Cuilab/open_dataset_information/ABCD/info/p.factor/4.pfactor_0y.csv")
pFactor.WX2 <- read.csv("/Users/xuxiaoyu_work/Cuilab/open_dataset_information/ABCD/info/p.factor/4.pfactor_2y.csv")
pFactor.WX0$scanID <- paste0("sub-", gsub("_", "", pFactor.WX0$ID), "_ses-baselineYear1Arm1")
pFactor.WX2$scanID <- paste0("sub-", gsub("_", "", pFactor.WX2$ID), "_ses-2YearFollowUpYArm1")
pFactor.WX <- rbind(pFactor.WX0, pFactor.WX2)

demodf_s4 <- demodf_s4 %>% left_join(select(pFactor.WX, c("general", "scanID")), by="scanID")
write.csv(demodf_s4, paste0(info_path, '/DemodfScreenFinal.csv'), row.names = F)


```
