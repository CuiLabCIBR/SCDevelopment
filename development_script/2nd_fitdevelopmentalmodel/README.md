# 2nd_fitdevelopmentalmodel
This folder contains codes for developmental analyses that estimate age effects, compute derivatives, and examine correlations between developmental patterns and connectional axis rank. The permutation ID required for the spin test, along with the code to generate it, are also included in this folder. It includes scripts for generating `Fig. 2a~f, Fig. 3b~d, Fig. 5a~f`. Separate scripts are provided for the ABCD and HCP-D datasets for each step. For sensitivity analyses, users can specify the resolutions of large-scale SC matrices for the first two steps, and specify the consistency threshold for all the steps. Additionally, this folder contains scripts for validation analyses of different resolutions, named `V3rd_visualizationfitSCcurves_SA_ds_sumSCinvnode_*.R` and `V4th_correlationTo_SArank_SA_ds_sumSCinvnode_*.R`, which closely mirror the main scripts they correspond to.

## S1st_fitgammodels_SA_ds_sumSCinvnode_*.R
This script fitted developmental models for each edge. The resolutions of the large-scale structural connectivity matrix and the consistency threshold can be specified. Generalized Additive Models (GAM) were used for samples from the HCP-D dataset, and Generalized Additive Mixed Models (GAMM) were used for samples from the ABCD dataset. For each model, the structural connectivity strength per edge was set as the dependent variable, age was set as the smooth term, and gender, handedness, race, and head motion were set as covariates. Knots for the smooth function were set at three, and the restricted maximum likelihood approach was used to estimate smoothing parameters.

In this script, statistical parameters were first calculated and saved as `gamresults78_sumSCinvnode_over8_CV75.rds` (12x12 matrix, P75th threshold, can be found in `interfileFolder`). Then, the GAM models were saved as `gammodel78_sumSCinvnode_over8_CV75.rds` (12x12 matrix, P75th threshold, not available). Next, fitted values at 1,000 equispaced values of age were generated and saved as `plotdatasum.df_SA12_sumSCinvnode_CV75.rds` (not available). It’s worth noting that to avoid the influence of the averaged weight of each edge's strength on derivative analysis or visualization, we divided the structural strength of each edge by their fitted value at the onset age (8 for the HCP-D dataset; 8.9 for the ABCD dataset). The scaled value represents the ratio of structural connectivity strength relative to the initial strength during the interested age span. The scaled data was saved as `SCdata.diw_SA12CV75.rds` (not available). Finally, GAM models, as well as the statistical parameters, were computed and saved as `gamresults78_sumSCinvnode_over8_CV75_scale_TRUE.rds` (can be found in `interfileFolder`) and `gammodel78_sumSCinvnode_over8_CV75_scale_TRUE.rds` (not available).

## S2nd_calculatederivative_*.R
This script generated derivative and posterior derivative values for scaled GAM or GAMM models. We sampled 1,000 age points at equal intervals from the age range of two datasets. For each age point, the 1st derivative was computed and saved as `derivative.df78_CV75.rds` (not available). Additionally, to ensure the reliability of alignment between derivatives and the connectional axis, we drew 1,000 samples from the posterior derivatives of each edge's age smooth function saved as `derivative.posterior.df.SA12_CV75.rds` (not available). Because the first derivative is used to reflect age effects at a specific age point and to analyze the heterogeneity of the developmental effects for all structural connections at each age point, we aimed to prevent the first derivative from being affected by the varying scales of structural connectivity strength of connections. Therefore, scaled GAM or GAMM objects were used to generate derivative and posterior derivative values.

## S3rd_visualizationfitSCcurves_SA12sumSCinvnode_*.R
This script elucidates the developmental trajectories of 78 connections, subsequently aggregating them into deciles based on the sensorimotor-association (S-A) connectional axis. Firstly, it illustrates the developmental trajectories by depicting the ratio of structural connectivity strength relative to its initial value at the youngest age within the observed age range (`Fig. 2b`, `Fig. 5b`) alongside z-scored fits (`Fig. 2d`, `Supplementary Fig. S2c`) for all 78 connections. Next, to delineate the diverse developmental patterns along the S-A connectional axis, it averages the model fits for connections within each decile of the axis (`Fig. 5e`, `Supplementary Fig. S3c`) followed by the calculation of z-scores for these averages (`Fig. 3d`).
This note is also suitable for `V3rd_visualizationfitSCcurves_SA_ds_sumSCinvnode_*.R` (validation codes).

## S4th_correlationTo_SArank_SA12sumSCinvnode_*.R
This script conducted correlation analyses between developmental parameters and the S-A connectional axis rank and adopted spin tests to estimate their significance. The functions of spin tests come from [Váša, F. et al., 2018](https://github.com/frantisekvasa/rotate_parcellation). We referred to [Hansen et al., 2022](https://github.com/netneurolab/hansen_crossdisorder_vulnerability/blob/main/code/03_disorder_similarity.py) to generate permutation ID for matrix. See `spintestPermID` for codes generating permutation index for connections. For details, the 12 cortical nodes were first rotated 10,000 times for the left and right hemispheres separately, and the rotation IDs were saved. Next, because we divided the nodes into 12 fractions based on the S-A axis without distinguishing between the left and right hemispheres, the permutation IDs for the matrix were generated by rotating the nodes based on the rotation ID of the left hemisphere first and then based on the rotation ID of the right hemisphere. As a result, 20,000 permutations were performed for the matrix. The p-values from the spin tests were computed by comparing the actual rho with the null rho. The function of the connectional spin test was put in the folder of `gamfunction`, with the name `SCrankcorr.R`. `Fig. 2a,c`, `Fig. 3b,c`, `Fig. 5a,c~e`, `Supplementary Fig. S3a,b,d`, `Supplementary Fig. S4a,c` were generated by this script.
This script also conducted validation tests to control for the impact of fiber length (`Supplementary Fig. S9a,b,d,e,g,h`). It performed regression analyses to remove the effect of mean fiber length from the average second derivatives and the partial R-squared values for the 78 connections. Subsequently, correlation analyses were carried out between the residuals and the connectional axis to further investigate their relationship.
This note is also suitable for `V4th_correlationTo_SArank_SA_ds_sumSCinvnode_*.R` (validation codes).

## V1st_check_k.R
This script was utilized to select the optimal (k) values for the smoothing functions in GAM and GAMM. We tested (k) values ranging from 3 to 6, and observed that models with a (k) value of 3 consistently exhibited the lowest Akaike Information Criterion (AIC), indicating optimal fit. Consequently, we established the number of knots at 3 for both GAM and GAMM implementations.

# SpintestPermID
Scripts in this folder generated permutation indices for connectional spin tests.


